<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSVå¯¼å…¥åŠŸèƒ½æœ€ç»ˆéªŒè¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .verification-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .console-output {
            background: #1e1e1e;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 15px 0;
        }
        .file-test-area {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            border-radius: 5px;
        }
        .test-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .test-item {
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="verification-container">
        <h1>ğŸ”¬ CSVå¯¼å…¥åŠŸèƒ½æœ€ç»ˆéªŒè¯</h1>

        <div class="status info">
            æ­¤é¡µé¢ç”¨äºéªŒè¯ç‚¹åç¥å™¨çš„CSVå¯¼å…¥åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚
        </div>

        <div class="file-test-area">
            <h3>ğŸ“ æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h3>
            <input type="file" id="csvFile" accept=".csv" style="margin: 10px;">
            <br>
            <button onclick="simulateRealCSVImport()">ğŸ§ª æ¨¡æ‹ŸçœŸå®CSVå¯¼å…¥</button>
            <button onclick="testWithSampleData()">ğŸ“‹ ä½¿ç”¨ç¤ºä¾‹æ•°æ®æµ‹è¯•</button>
            <button onclick="clearConsole()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="test-results">
            <div class="test-item" id="fileReaderStatus">
                <h4>ğŸ“– FileReader</h4>
                <div>æœªæµ‹è¯•</div>
            </div>
            <div class="test-item" id="csvParserStatus">
                <h4>ğŸ” CSVè§£æå™¨</h4>
                <div>æœªæµ‹è¯•</div>
            </div>
            <div class="test-item" id="localStorageStatus">
                <h4>ğŸ’¾ LocalStorage</h4>
                <div>æœªæµ‹è¯•</div>
            </div>
            <div class="test-item" id="rollCallSystemStatus">
                <h4>ğŸ¯ ç‚¹åç³»ç»Ÿ</h4>
                <div>æœªæµ‹è¯•</div>
            </div>
        </div>

        <div class="console-output" id="consoleOutput">
ç­‰å¾…æµ‹è¯•å¼€å§‹...
ä½¿ç”¨Chrome DevToolsæŸ¥çœ‹è¯¦ç»†æ—¥å¿—
        </div>

        <div class="status warning">
            <strong>æµ‹è¯•æ­¥éª¤ï¼š</strong><br>
            1. ç‚¹å‡»"æ¨¡æ‹ŸçœŸå®CSVå¯¼å…¥"æˆ–é€‰æ‹©CSVæ–‡ä»¶<br>
            2. è§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºå’Œä¸Šæ–¹çŠ¶æ€æŒ‡ç¤ºå™¨<br>
            3. éªŒè¯æ‰€æœ‰åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ<br>
            4. æ£€æŸ¥localStorageä¸­æ˜¯å¦æ­£ç¡®ä¿å­˜äº†å­¦ç”Ÿæ•°æ®
        </div>
    </div>

    <script>
        let consoleOutput = '';

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            consoleOutput += `[${timestamp}] ${icon} ${message}\n`;
            updateConsole();
            console.log(`${icon} ${message}`);
        }

        function updateConsole() {
            document.getElementById('consoleOutput').textContent = consoleOutput;
            document.getElementById('consoleOutput').scrollTop = document.getElementById('consoleOutput').scrollHeight;
        }

        function clearConsole() {
            consoleOutput = 'æ§åˆ¶å°å·²æ¸…ç©º...\n';
            updateConsole();
        }

        function updateStatus(testId, status, message) {
            const element = document.getElementById(testId);
            const statusDiv = element.querySelector('div');
            statusDiv.textContent = message;

            element.className = 'test-item';
            if (status === 'success') {
                element.style.background = '#d4edda';
                element.style.color = '#155724';
            } else if (status === 'error') {
                element.style.background = '#f8d7da';
                element.style.color = '#721c24';
            } else if (status === 'warning') {
                element.style.background = '#fff3cd';
                element.style.color = '#856404';
            } else {
                element.style.background = '#d1ecf1';
                element.style.color = '#0c5460';
            }
        }

        // æ¨¡æ‹ŸçœŸå®çš„CSVå¯¼å…¥è¿‡ç¨‹
        function simulateRealCSVImport() {
            log('ğŸš€ å¼€å§‹æ¨¡æ‹ŸçœŸå®CSVå¯¼å…¥è¿‡ç¨‹...');

            // è·å–ç¤ºä¾‹CSVæ•°æ®
            const sampleCSVData = `å¼ ä¸‰
æå››
ç‹äº”
èµµå…­
é™ˆä¸ƒ
åˆ˜å…«
å‘¨ä¹
å´å
éƒ‘åä¸€
å­™åäºŒ`;

            // 1. æµ‹è¯•FileReaderåŠŸèƒ½
            log('ğŸ“– æµ‹è¯•1: FileReaderåŠŸèƒ½...');
            updateStatus('fileReaderStatus', 'info', 'æµ‹è¯•ä¸­...');

            try {
                const blob = new Blob([sampleCSVData], { type: 'text/csv' });
                const reader = new FileReader();

                reader.onload = function(e) {
                    const content = e.target.result;
                    log(`FileReaderè¯»å–æˆåŠŸï¼Œå†…å®¹é•¿åº¦: ${content.length}`, 'success');
                    updateStatus('fileReaderStatus', 'success', 'âœ… æ­£å¸¸');

                    // 2. æµ‹è¯•CSVè§£æåŠŸèƒ½
                    log('ğŸ” æµ‹è¯•2: CSVè§£æåŠŸèƒ½...');
                    updateStatus('csvParserStatus', 'info', 'æµ‹è¯•ä¸­...');

                    try {
                        const lines = content.split('\n');
                        const validLines = lines.filter(line => line.trim().length > 0);

                        log(`åŸå§‹è¡Œæ•°: ${lines.length}`, 'info');
                        log(`æœ‰æ•ˆè¡Œæ•°: ${validLines.length}`, 'info');

                        if (validLines.length > 0) {
                            // è§£æå­¦ç”Ÿæ•°æ®
                            const students = [];
                            validLines.forEach((line, index) => {
                                const name = line.trim().replace(/['"]/g, '');
                                if (name) {
                                    students.push({
                                        id: Date.now() + index,
                                        name: name,
                                        rollCount: 0,
                                        presentCount: 0,
                                        lateCount: 0,
                                        absentCount: 0,
                                        lastRollTime: null
                                    });
                                }
                            });

                            log(`æˆåŠŸè§£æ ${students.length} åå­¦ç”Ÿ`, 'success');
                            students.forEach((student, index) => {
                                log(`  ${index + 1}. ${student.name}`, 'info');
                            });

                            updateStatus('csvParserStatus', 'success', 'âœ… æ­£å¸¸');

                            // 3. æµ‹è¯•localStorageä¿å­˜
                            log('ğŸ’¾ æµ‹è¯•3: LocalStorageä¿å­˜...');
                            updateStatus('localStorageStatus', 'info', 'æµ‹è¯•ä¸­...');

                            try {
                                localStorage.setItem('verificationStudents', JSON.stringify(students));
                                const savedStudents = JSON.parse(localStorage.getItem('verificationStudents'));

                                if (savedStudents && savedStudents.length === students.length) {
                                    log(`æˆåŠŸä¿å­˜å’Œè¯»å– ${savedStudents.length} åå­¦ç”Ÿæ•°æ®`, 'success');
                                    updateStatus('localStorageStatus', 'success', 'âœ… æ­£å¸¸');

                                    // 4. æµ‹è¯•RollCallSystemé›†æˆ
                                    log('ğŸ¯ æµ‹è¯•4: RollCallSystemé›†æˆ...');
                                    updateStatus('rollCallSystemStatus', 'info', 'æµ‹è¯•ä¸­...');

                                    // æ¨¡æ‹Ÿç³»ç»Ÿåˆå§‹åŒ–
                                    if (typeof window !== 'undefined') {
                                        // åˆ›å»ºæ¨¡æ‹Ÿçš„RollCallSystemå®ä¾‹
                                        window.mockRollCallSystem = {
                                            students: savedStudents,
                                            loadStudents: function() {
                                                this.students = savedStudents;
                                                log('RollCallSystemåŠ è½½å­¦ç”Ÿæ•°æ®æˆåŠŸ', 'success');
                                                updateStatus('rollCallSystemStatus', 'success', 'âœ… æ­£å¸¸');
                                            }
                                        };

                                        window.mockRollCallSystem.loadStudents();
                                    }

                                    log('ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼CSVå¯¼å…¥åŠŸèƒ½æ­£å¸¸å·¥ä½œ', 'success');

                                } else {
                                    log('localStorageä¿å­˜æˆ–è¯»å–å¤±è´¥', 'error');
                                    updateStatus('localStorageStatus', 'error', 'âŒ å¤±è´¥');
                                }

                            } catch (storageError) {
                                log(`localStorageæµ‹è¯•å¤±è´¥: ${storageError.message}`, 'error');
                                updateStatus('localStorageStatus', 'error', 'âŒ å¤±è´¥');
                            }

                        } else {
                            log('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å­¦ç”Ÿæ•°æ®', 'error');
                            updateStatus('csvParserStatus', 'error', 'âŒ å¤±è´¥');
                        }

                    } catch (parseError) {
                        log(`CSVè§£æå¤±è´¥: ${parseError.message}`, 'error');
                        updateStatus('csvParserStatus', 'error', 'âŒ å¤±è´¥');
                    }
                };

                reader.onerror = function() {
                    log('FileReaderè¯»å–å¤±è´¥', 'error');
                    updateStatus('fileReaderStatus', 'error', 'âŒ å¤±è´¥');
                };

                reader.readAsText(blob);

            } catch (readerError) {
                log(`FileReaderæµ‹è¯•å¤±è´¥: ${readerError.message}`, 'error');
                updateStatus('fileReaderStatus', 'error', 'âŒ å¤±è´¥');
            }
        }

        // ä½¿ç”¨ç¤ºä¾‹æ•°æ®æµ‹è¯•
        function testWithSampleData() {
            log('ğŸ“‹ ä½¿ç”¨ç¤ºä¾‹å­¦ç”Ÿåå•æ•°æ®æµ‹è¯•...');

            // åˆ›å»ºå®Œæ•´çš„29åå­¦ç”Ÿæ•°æ®
            const fullStudentList = `å¼ ä¸‰
æå››
ç‹äº”
èµµå…­
é™ˆä¸ƒ
åˆ˜å…«
å‘¨ä¹
å´å
éƒ‘åä¸€
å­™åäºŒ
é’±åä¸‰
æåå››
å‘¨åäº”
å´åå…­
éƒ‘åä¸ƒ
å†¯åå…«
é™ˆåä¹
è¤šäºŒå
å«äºŒä¸€
è’‹äºŒäºŒ
æ²ˆäºŒä¸‰
éŸ©äºŒå››
æ¨äºŒäº”
æœ±äºŒå…­
ç§¦äºŒä¸ƒ
å°¤äºŒå…«
è®¸äºŒä¹
ä½•ä¸‰å
å•ä¸‰ä¸€`;

            // æ¨¡æ‹Ÿæ–‡ä»¶å’Œè¯»å–è¿‡ç¨‹
            const blob = new Blob([fullStudentList], { type: 'text/csv' });
            const file = new File([blob], 'ç¤ºä¾‹å­¦ç”Ÿåå•.csv', { type: 'text/csv' });

            log(`ğŸ“„ åˆ›å»ºæµ‹è¯•æ–‡ä»¶: ${file.name}`, 'info');
            log(`ğŸ“Š æ–‡ä»¶å¤§å°: ${file.size} bytes`, 'info');

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n').filter(line => line.trim());

                log(`ğŸ¯ å®Œæ•´ç¤ºä¾‹åå•åŒ…å« ${lines.length} åå­¦ç”Ÿ`, 'success');

                // ä¿å­˜åˆ°localStorageç”¨äºä¸»ç¨‹åºæµ‹è¯•
                const students = lines.map((line, index) => ({
                    id: Date.now() + index,
                    name: line.trim(),
                    rollCount: 0,
                    presentCount: 0,
                    lateCount: 0,
                    absentCount: 0,
                    lastRollTime: null
                }));

                localStorage.setItem('students', JSON.stringify(students));
                log(`ğŸ’¾ å·²ä¿å­˜å®Œæ•´å­¦ç”Ÿåå•åˆ°localStorageï¼Œå¯åœ¨ä¸»ç¨‹åºä¸­ä½¿ç”¨`, 'success');
            };

            reader.readAsText(file);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            log('ğŸ¯ CSVå¯¼å…¥åŠŸèƒ½æœ€ç»ˆéªŒè¯é¡µé¢å·²åŠ è½½', 'success');
            log('é€‰æ‹©CSVæ–‡ä»¶æˆ–ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹éªŒè¯', 'info');

            // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
            if (typeof FileReader !== 'undefined') {
                log('âœ… æµè§ˆå™¨æ”¯æŒFileReader API', 'success');
            } else {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒFileReader API', 'error');
            }

            if (typeof localStorage !== 'undefined') {
                log('âœ… æµè§ˆå™¨æ”¯æŒlocalStorage', 'success');
            } else {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒlocalStorage', 'error');
            }
        });

        // ç›‘å¬æ–‡ä»¶é€‰æ‹©
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                log(`ğŸ“ é€‰æ‹©äº†æ–‡ä»¶: ${file.name} (${file.size} bytes)`, 'info');

                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const lines = content.split('\n').filter(line => line.trim());
                    log(`ğŸ“Š è§£æåˆ° ${lines.length} è¡Œæ•°æ®`, 'success');

                    lines.slice(0, 5).forEach((line, index) => {
                        log(`  ${index + 1}. ${line.trim()}`, 'info');
                    });

                    if (lines.length > 5) {
                        log(`  ... è¿˜æœ‰ ${lines.length - 5} è¡Œæ•°æ®`, 'info');
                    }
                };
                reader.readAsText(file);
            }
        });
    </script>
</body>
</html>